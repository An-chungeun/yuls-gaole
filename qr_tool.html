<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>QR ë“±ë¡ íˆ´ - í¬ì¼“ëª¬ ê°€ì˜¤ë ˆ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f9f9f9;
      text-align: center;
    }
    input, textarea {
      width: 90%;
      max-width: 600px;
      padding: 10px;
      margin: 10px auto;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
    }
    table {
      width: 100%;
      max-width: 1000px;
      margin: 20px auto;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
    }
    button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>

  <h1>ğŸ“‹ QR ë“±ë¡ ì „ìš© íˆ´</h1>

  <h2>1ï¸âƒ£ QR ì½”ë“œ ì´ë¯¸ì§€ ì—…ë¡œë“œ</h2>
  <input type="file" id="imageInput" accept="image/*" multiple />
  <div id="imageStatus">ì´ë¯¸ì§€ ì²˜ë¦¬ ê²°ê³¼: <span id="statusText">ì—†ìŒ</span></div>

  <h2>2ï¸âƒ£ ìˆ˜ë™ QR ì…ë ¥ë„ ê°€ëŠ¥</h2>
  <textarea id="qrInput" rows="5" placeholder="QR ì½”ë“œ ì›ë¬¸ì„ ì¤„ ë‹¨ìœ„ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>
  <button onclick="addManualQR()">ìˆ˜ë™ QR ì¶”ê°€</button>

  <h2>ğŸ§¾ QR ë“±ë¡ ëª©ë¡</h2>
  <div id="outputTable"></div>
  <button onclick="downloadCSV()">CSV ë‹¤ìš´ë¡œë“œ</button>
  <button onclick="downloadJSON()">JSON ë‹¤ìš´ë¡œë“œ</button>
  <button onclick="downloadBoth()">CSV + JSON ë‹¤ìš´ë¡œë“œ</button>

  <script>
    let qrInfoDB = {};
    let registeredData = [];

    // gaoleQR.json ë¶ˆëŸ¬ì˜¤ê¸°
    fetch('gaoleQR.json')
      .then(res => res.json())
      .then(data => { qrInfoDB = data; });

    // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
    document.getElementById('imageInput').addEventListener('change', function(event) {
      const files = event.target.files;
      if (!files.length) return;

      const statusText = document.getElementById('statusText');
      statusText.textContent = "ì²˜ë¦¬ ì¤‘...";

      let processedCount = 0;

      Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const imageDataUrl = e.target.result;

          Html5Qrcode.getCameras(); // to initialize if needed
          const html5QrCode = new Html5Qrcode("temp-scan");

          html5QrCode.scanFile(file, true)
            .then(qrMessage => {
              const base64 = btoa(unescape(encodeURIComponent(qrMessage.trim())));
              if (qrInfoDB[base64]) {
                addToTable(base64, qrInfoDB[base64]);
              } else {
                alert("QR ì¸ì‹ ì„±ê³µí–ˆì§€ë§Œ ì •ë³´ê°€ ë“±ë¡ë˜ì§€ ì•Šì€ ì½”ë“œì…ë‹ˆë‹¤:\n" + base64);
              }
              processedCount++;
              if (processedCount === files.length) statusText.textContent = "ì™„ë£Œ";
            })
            .catch(err => {
              const failItem = document.createElement("p");
              failItem.style.color = "crimson";
              failItem.textContent = "âŒ ì¸ì‹ ì‹¤íŒ¨: " + file.name;
              document.getElementById("imageStatus").appendChild(failItem);
              processedCount++;
              if (processedCount === files.length) statusText.textContent = "ì™„ë£Œ (ì¼ë¶€ ì‹¤íŒ¨)";
            });
        };
        reader.readAsDataURL(file);
      });
    });

    // ìˆ˜ë™ ì…ë ¥ QR
    function addManualQR() {
      const lines = document.getElementById('qrInput').value.trim().split('\n');
      lines.forEach(raw => {
        const base64 = btoa(unescape(encodeURIComponent(raw.trim())));
        if (qrInfoDB[base64]) {
          addToTable(base64, qrInfoDB[base64]);
        } else {
          alert("ë“±ë¡ë˜ì§€ ì•Šì€ QR ì½”ë“œì…ë‹ˆë‹¤: \n" + base64);
        }
      });
    }

    // í…Œì´ë¸”ì— ì¶”ê°€
    function addToTable(base64, info) {
      const row = {
        qr: base64,
        engname: info.engname,
        name: info.name,
        code: info.code || "",
        energy: info.energy || "",
        move: info.move || "",
        type: info.type || "",
        hp: info.hp || "",
        spa: info.spa || "",
        def: info.def || "",
        spd: info.spd || "",
        spe: info.spe || "",
        img: info.img || ""
      };
      registeredData.push(row);
      renderTable();
    }

    // í‘œ ë Œë”ë§
    function renderTable() {
      const header = [
        "qr","engname","name","code","energy","move","type",
        "hp","spa","def","spd","spe","img"
      ];

      let html = `<table><tr>${header.map(h => `<th>${h}</th>`).join('')}</tr>`;
      registeredData.forEach(row => {
        html += `<tr>${header.map(h => `<td>${row[h]}</td>`).join('')}</tr>`;
      });
      html += `</table>`;
      document.getElementById("outputTable").innerHTML = html;
    }

    // CSV ë‹¤ìš´ë¡œë“œ
    function downloadCSV() {
      const header = [
        "qr","engname","name","code","energy","move","type",
        "hp","spa","def","spd","spe","img"
      ];
      const csv = [
        header.join(","),
        ...registeredData.map(row => header.map(h => `"${row[h]}"`).join(","))
      ].join("\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "gaoleQR.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    // JSON ë‹¤ìš´ë¡œë“œ
    function downloadJSON() {
      const jsonObj = {};
      registeredData.forEach(row => {
        jsonObj[row.qr] = {
          engname: row.engname,
          name: row.name,
          code: row.code,
          energy: row.energy,
          move: row.move,
          type: row.type,
          hp: row.hp,
          spa: row.spa,
          def: row.def,
          spd: row.spd,
          spe: row.spe,
          img: row.img
        };
      });

      const blob = new Blob([JSON.stringify(jsonObj, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "gaoleQR.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    // ë‘˜ ë‹¤ ë‹¤ìš´ë¡œë“œ
    function downloadBoth() {
      downloadCSV();
      downloadJSON();
    }
  </script>

  <!-- QR ì¸ì‹ìš© ì„ì‹œ ìš”ì†Œ (ë³´ì´ì§€ ì•Šê²Œ) -->
  <div id="temp-scan" style="display:none;"></div>
</body>
</html>
